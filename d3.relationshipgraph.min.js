(function(){"use strict";d3.relationshipGraph=function(){return RelationshipGraph.extend.apply(RelationshipGraph,arguments)};d3.selection.prototype.relationshipGraph=function(showTooltips,maxChildCount,onClick){return new RelationshipGraph(this,showTooltips,maxChildCount,onClick)};d3.selection.enter.prototype.relationshipGraph=function(){return this.graph}})();var RelationshipGraph=function(){"use strict";Object.prototype.containsKey=function(key){return Object.keys(this).indexOf(key)>-1};Array.prototype.contains=function(key){return this.indexOf(key)>-1};String.prototype.abbreviate=function(){return this.length>=25?this.substring(0,25)+"...":this};var noop=function(){};function RelationshipGraph(selection,showTooltips,maxChildCount,onClick){this.config={blockSize:24,selection:selection,showTooltips:showTooltips||true,maxChildCount:maxChildCount||0,onClick:onClick||noop,showKeys:true};this.allowedDirections=["n","ne","e","se","s","sw","w","nw"];this.ctx=document.createElement("canvas").getContext("2d");this.ctx.font="90% Helvetica";var createTooltip=function(that){var self=that;return d3.tip().attr("class","relationshipGraph-tip").offset([-8,-10]).html(function(obj){var keys=Object.keys(obj),table=document.createElement("table"),hiddenKeys=["ROW","INDEX","COLOR","PARENTCOLOR","PARENT"];keys.forEach(function(element){var upperCaseKey=element.toUpperCase();if(!hiddenKeys.contains(upperCaseKey)){var row=document.createElement("tr"),key=self.graph.config.showKeys?document.createElement("td"):null,value=document.createElement("td");if(self.graph.config.showKeys){key.innerHTML=element;row.appendChild(key)}value.innerHTML=obj[element];value.style.fontWeight="normal";row.appendChild(value);table.appendChild(row)}});return table.outerHTML})};if(this.config.showTooltips){this.tip=createTooltip(this);this.setTooltipPlacement("w")}else{this.tip=null}this.svg=this.config.selection.append("svg").attr("width","500").attr("height","500").attr("style","display: block").append("g").attr("transform","translate(10, 0)");this.graph=this}RelationshipGraph.prototype.showTooltipKeys=function(showKeys){this.config.showKeys=showKeys};RelationshipGraph.prototype.setTooltipPlacement=function(position){if(this.allowedDirections.contains(position)&&this.tip!==undefined){this.tip.direction(position)}};RelationshipGraph.prototype.verifyJson=function(json){if(json===undefined||json.length===0){throw"JSON cannot be empty."}json.forEach(function(element){if(element.parent===undefined){throw"Child does not have a parent."}else if(element.color===undefined||element.color>3||element.color<0){throw"Child color is unsupported."}else if(element.parentColor===undefined||element.parentColor>4||element.parentColor<0){throw"Parent color is unsupported."}});return true};RelationshipGraph.prototype.generate=function(json){if(this.verifyJson(json)){var row=1,index=1,previousParent=null,parents=[],parentSizes={},colors=["#abdda4","#fdae61","#d7191c","#2b83ba"],maxWidth=0,maxHeight=0,that=this;json.sort(function(child1,child2){if(child1.parent<child2.parent){return-1}else if(child1.parent>child2.parent){return 1}else{return 0}});json.forEach(function(element){var parent=element.parent;if(parentSizes.containsKey(parent)){parentSizes[parent]++}else{parentSizes[parent]=1;parents.push(parent.abbreviate())}});var longest="";parents.forEach(function(element,index){var current=element+"   ("+parentSizes[Object.keys(parentSizes)[index]]+")   ";if(current.length>longest.length){longest=current}});var parentDiv=this.config.selection[0][0],calculatedMaxChildren=this.config.maxChildCount===0?Math.floor((parentDiv.parentElement.clientWidth-75)/this.config.blockSize):this.config.maxChildCount;json.forEach(function(element){var parent=element.parent;if(previousParent!==null&&previousParent!==parent){element.row=row+1;element.index=1;index=2;row++}else{if(index===calculatedMaxChildren+1){index=1;row++}element.row=row;element.index=index;index++}previousParent=parent});this.svg.selectAll(".row").data(parents).enter().append("text").text(function(obj,index){return obj+" ("+parentSizes[Object.keys(parentSizes)[index]]+")"}).attr("x",0).attr("y",function(obj,index){if(index===0){return 0}var previousParentSize=0;for(var i=index-1;i>-1;i--){previousParentSize+=Math.ceil(parentSizes[Object.keys(parentSizes)[i]]/calculatedMaxChildren)*calculatedMaxChildren}var y=Math.ceil(previousParentSize/calculatedMaxChildren)*that.config.blockSize;maxHeight=y>maxHeight?y:maxHeight;return y}).style("text-anchor","start").style("fill",function(obj){return colors[obj.parentColor]||colors[4]}).attr("class","relationshipGraph-Text").attr("transform","translate(-6, "+this.config.blockSize/1.5+")");var width=this.ctx.measureText(longest+"    ").width;var children=this.svg.selectAll(".child").data(json);children.enter().append("rect").attr("x",function(obj){var x=width+(obj.index-1)*that.config.blockSize;maxWidth+=x+that.config.blockSize>maxWidth?x+that.config.blockSize:0;return x}).attr("y",function(obj){var y=(obj.row-1)*that.config.blockSize;maxHeight+=y+that.config.blockSize>maxHeight?y+that.config.blockSize:0;return y}).attr("rx",4).attr("ry",4).attr("class","relationshipGraph-block").attr("width",that.config.blockSize).attr("height",that.config.blockSize).style("fill",function(obj){return colors[obj.color]||colors[0]}).on("mouseover",that.tip?that.tip.show:noop).on("mouseout",that.tip?that.tip.hide:noop).on("click",function(obj){that.tip.hide();that.config.onClick(obj)});children.exit().remove();if(this.config.showTooltips){d3.select(".d3-tip").remove();this.svg.call(this.tip)}this.svg.attr("width",maxWidth+15).attr("height",maxHeight+15)}};return RelationshipGraph}();