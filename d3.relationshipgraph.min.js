(function(){"use strict";d3.relationshipGraph=function(){return RelationshipGraph.extend.apply(RelationshipGraph,arguments)};d3.selection.prototype.relationshipGraph=function(userConfig){return new RelationshipGraph(this,userConfig)};d3.selection.enter.prototype.relationshipGraph=function(){return this.graph}})();var RelationshipGraph=function(){"use strict";var containsKey=function(obj,key){return Object.keys(obj).indexOf(key)>-1};var contains=function(obj,key){return obj.indexOf(key)>-1};var abbreviate=function(str){return str.length>=25?str.substring(0,25)+"...":str};var noop=function(){};var getPageTopLeft=function(el){var rect=el.getBoundingClientRect();var docEl=document.documentElement;return{top:rect.top+(window.pageYOffset||docEl.scrollTop||0),right:rect.right+(window.pageXOffset||0),bottom:rect.bottom+(window.pageYOffset||0),left:rect.left+(window.pageXOffset||docEl.scrollLeft||0)}};function RelationshipGraph(selection,userConfig){if(userConfig.thresholds===undefined||typeof userConfig.thresholds!=="object"){throw"Thresholds must be an Object."}this.config={blockSize:24,maxWidth:0,maxHeight:0,selection:selection,showTooltips:userConfig.showTooltips||true,maxChildCount:userConfig.maxChildCount||0,onClick:userConfig.onClick||noop,showKeys:userConfig.showKeys||true,thresholds:userConfig.thresholds,colors:userConfig.colors||["#c4f1be","#a2c3a4","#869d96","#525b76","#201e50","#485447","#5b7f77","#6474ad","#b9c6cb","#c0d6c1","#754668","#587d71","#4daa57","#b5dda4","#f9eccc","#0e7c7b","#17bebb","#d4f4dd","#d62246","#4b1d3f","#cf4799","#c42583","#731451","#f3d1bf","#c77745"],transitionTime:userConfig.transitionTime||1500};this.allowedDirections=["n","ne","e","se","s","sw","w","nw"];this.ctx=document.createElement("canvas").getContext("2d");this.ctx.font="10pt Helvetica";var createTooltip=function(self){var hiddenKeys=["ROW","INDEX","COLOR","PARENTCOLOR","PARENT"],showKeys=self.config.showKeys;return d3.tip().attr("class","relationshipGraph-tip").offset([-8,-10]).html(function(obj){var tip=document.querySelector(".relationshipGraph-tip"),tipWidth=tip.clientWidth,tipHeight=tip.clientHeight,windowWidth=window.innerWidth,windowHeight=window.innerHeight,elementCoordinates=getPageTopLeft(this),keys=Object.keys(obj),table=document.createElement("table"),count=keys.length,rows=[];if(!containsKey(tip.classList,"s")&&elementCoordinates.top-tipHeight<0){self.tip.direction("s")}else if(!containsKey(tip.classList,"w")&&elementCoordinates.right+tipWidth>windowWidth){self.tip.direction("w")}else if(!containsKey(tip.classList,"n")&&elementCoordinates.bottom+tipWidth>windowHeight){self.tip.direction("n")}else if(!containsKey(tip.classList,"e")&&elementCoordinates.left-tipHeight<0){self.tip.direction("e")}while(count--){var element=keys[count],upperCaseKey=element.toUpperCase();if(!contains(hiddenKeys,upperCaseKey)){var row=document.createElement("tr"),key=showKeys?document.createElement("td"):null,value=document.createElement("td");if(showKeys){key.innerHTML=element.charAt(0).toUpperCase()+element.substring(1);row.appendChild(key)}value.innerHTML=obj[element];value.style.fontWeight="normal";row.appendChild(value);rows.push(row)}}var rowCount=rows.length;while(rowCount--){table.appendChild(rows[rowCount])}self.tip.direction("w");return table.outerHTML})};if(this.config.showTooltips){this.tip=createTooltip(this)}else{this.tip=null}this.svg=this.config.selection.select("svg").select("g");if(this.svg.empty()){this.svg=this.config.selection.append("svg").attr("width","500").attr("height","500").attr("style","display: block").append("g").attr("transform","translate(10, 0)")}this.graph=this}RelationshipGraph.prototype.verifyJson=function(json){if(json===undefined||typeof JSON!=="object"||json.length===0){throw"JSON has to be a JavaScript object that is not empty."}var length=json.length;while(length--){var element=json[length],keys=Object.keys(element),keyLength=keys.length;if(element.parent===undefined){throw"Child does not have a parent."}else if(element.parentColor!==undefined&&(element.parentColor>4||element.parentColor<0)){throw"Parent color is unsupported."}while(keyLength--){if(keys[keyLength].toUpperCase()=="VALUE"){if(keys[keyLength]!="value"){json[length].value=json[length][keys[keyLength]];delete json[length][keys[keyLength]]}break}}}return true};RelationshipGraph.prototype.data=function(json){if(this.verifyJson(json)){var row=1,index=1,previousParent=null,parents=[],parentSizes={},previousParentSizes=0,that=this,parent,i;json.sort(function(child1,child2){if(child1.parent<child2.parent){return-1}else if(child1.parent>child2.parent){return 1}else{return 0}});for(i=0;i<json.length;i++){parent=json[i].parent;if(containsKey(parentSizes,parent)){parentSizes[parent]++}else{parentSizes[parent]=1;parents.push(abbreviate(parent))}}var longest="",parentNames=Object.keys(parentSizes);for(i=0;i<parents.length;i++){var current=parents[i]+" ( "+parentSizes[parentNames[i]]+") ";if(current.length>longest.length){longest=current}}var longestWidth=this.ctx.measureText(longest).width,parentDiv=this.config.selection[0][0],calculatedMaxChildren=this.config.maxChildCount===0?Math.floor((parentDiv.parentElement.clientWidth-15-longestWidth)/this.config.blockSize):this.config.maxChildCount;for(i=0;i<json.length;i++){var element=json[i];parent=element.parent;if(previousParent!==null&&previousParent!==parent){element.row=row+1;element.index=1;index=2;row++}else{if(index===calculatedMaxChildren+1){index=1;row++}element.row=row;element.index=index;index++}previousParent=parent;var value,compare;if(typeof that.config.thresholds[0]==="string"){value=element.value;compare=function(value,threshold){return value==threshold}}else{value=parseInt(element.value.replace(/\D/g,""));compare=function(value,threshold){return value<threshold}}for(var thresholdIndex=0;thresholdIndex<that.config.thresholds.length;thresholdIndex++){if(compare(value,that.config.thresholds[thresholdIndex])){element.color=thresholdIndex;break}}}var parentNodes=this.svg.selectAll(".relationshipGraph-Text").data(parents);parentNodes.enter().append("text").text(function(obj,index){return obj+" ("+parentSizes[Object.keys(parentSizes)[index]]+")"}).attr("x",0).attr("y",function(obj,index){if(index===0){return 0}var y=Math.ceil(previousParentSizes/calculatedMaxChildren)*that.config.blockSize;previousParentSizes+=y;that.config.maxHeight=y>that.config.maxHeight?y:that.config.maxHeight;return y}).style("text-anchor","start").style("fill",function(obj){return obj.parentColor!==undefined?that.config.colors[obj.parentColor]:"#000000"}).attr("class","relationshipGraph-Text").attr("transform","translate(-6, "+this.config.blockSize/1.5+")");parentNodes.text(function(obj,index){return obj+" ("+parentSizes[Object.keys(parentSizes)[index]]+")"}).attr("y",function(obj,index){if(index===0){return 0}var previousParentSize=0,i=index-1;while(i>-1){previousParentSize+=Math.ceil(parentSizes[Object.keys(parentSizes)[i]]/calculatedMaxChildren)*calculatedMaxChildren;i--}var y=Math.ceil(previousParentSize/calculatedMaxChildren)*that.config.blockSize;that.config.maxHeight=y>that.config.maxHeight?y:that.config.maxHeight;return y}).style("fill",function(obj){return obj.parentColor!==undefined?that.config.colors[obj.parentColor]:"#000000"});parentNodes.exit().remove();var childrenNodes=this.svg.selectAll(".relationshipGraph-block").data(json);childrenNodes.enter().append("rect").attr("x",function(obj){var x=longestWidth+(obj.index-1)*that.config.blockSize;that.config.maxWidth+=x+that.config.blockSize>that.config.maxWidth?x+that.config.blockSize:0;return x}).attr("y",function(obj){var y=(obj.row-1)*that.config.blockSize;that.config.maxHeight+=y+that.config.blockSize>that.config.maxHeight?y+that.config.blockSize:0;return y}).attr("rx",4).attr("ry",4).attr("class","relationshipGraph-block").attr("width",that.config.blockSize).attr("height",that.config.blockSize).style("fill",function(obj){return that.config.colors[obj.color%that.config.colors.length]||that.config.colors[0]}).on("mouseover",that.tip?that.tip.show:noop).on("mouseout",that.tip?that.tip.hide:noop).on("click",function(obj){that.tip.hide();that.config.onClick(obj)});childrenNodes.transition(that.config.transitionTime).attr("x",function(obj){var x=longestWidth+(obj.index-1)*that.config.blockSize;that.config.maxWidth+=x+that.config.blockSize>that.config.maxWidth?x+that.config.blockSize:0;return x}).attr("y",function(obj){var y=(obj.row-1)*that.config.blockSize;that.config.maxHeight+=y+that.config.blockSize>that.config.maxHeight?y+that.config.blockSize:0;return y}).style("fill",function(obj){return that.config.colors[obj.color%that.config.colors.length]||that.config.colors[0]});childrenNodes.exit().transition(that.config.transitionTime).remove();if(this.config.showTooltips){d3.select(".d3-tip").remove();this.svg.call(this.tip)}this.config.selection.select("svg").attr("width",that.config.maxWidth+15).attr("height",that.config.maxHeight+15)}};return RelationshipGraph}();